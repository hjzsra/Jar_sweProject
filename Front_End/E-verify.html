<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Verify Email — JAR</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="global-buttons.css">
    <style>
        /* small page-specific tweaks */
        .verify-input{width:220px;max-width:80%;padding:14px 18px;border-radius:10px;border:1px solid #ccc;text-align:center;font-size:20px;letter-spacing:8px}
        .Instruction{margin-bottom:18px}
        .Button-Row{margin-top:18px}
    </style>
</head>
<body>

    <main class="Screen" role="main">
        <section class="Hero-Box" role="region" aria-label="Email verification">
            <div class="Content-Wrapper">
                <h1 class="Text-Large">Verify Your University Email</h1>
                <p class="Text-Medium Instruction">We've sent a 6-digit verification code to your university email. Enter it below.</p>

                <form id="verifyForm" aria-label="Email verification form">
                    <div style="display:flex;flex-direction:column;align-items:center;">
                        <input id="codeInput" name="code" type="text" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" class="verify-input" required aria-label="6-digit verification code">
                        <p class="Text-Small" style="margin-top:12px">Didn't receive the code? Request a new one in 1 minute.</p>
                        <div class="Button-Row">
                            <button type="submit" class="Button-Base">Verify</button>
                        </div>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <script>
        const USERNAME_TO_VERIFY = 'driver-user-example';
        const API_URL = 'http://127.0.0.1:8000/api/auth/verify-otp/';

        async function handleVerify(event){
            event.preventDefault();
            const btn = event.currentTarget.querySelector('button[type="submit"]');
            const code = document.getElementById('codeInput').value.trim();

            if(!/^[0-9]{6}$/.test(code)){
                alert('Enter a 6-digit code');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Verifying...';

            const payload = { username: USERNAME_TO_VERIFY, email_otp: code };

            try{
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json().catch(()=> ({}));

                if(res.ok){
                    alert('Email verified — proceeding to phone verification.');
                    window.location.href = 'phone-verify.html';
                    return;
                }

                const msg = (data && (data.error || data.detail)) || 'Verification failed. Check the code and try again.';
                alert('Verification failed: ' + msg);

            } catch(err){
                console.error(err);
                alert('Network error — please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Verify';
            }
        }

        document.getElementById('verifyForm').addEventListener('submit', handleVerify);
    </script>

</body>
</html>